//©///////////////////////////////////////////////////////////////////////////©//
//
//  Copyright 2021-2025 BIA-Technologies Limited Liability Company
//
//  Licensed under the Apache License, Version 2.0 (the "License");
//  you may not use this file except in compliance with the License.
//  You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
//  Unless required by applicable law or agreed to in writing, software
//  distributed under the License is distributed on an "AS IS" BASIS,
//  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//  See the License for the specific language governing permissions and
//  limitations under the License.
//
//©///////////////////////////////////////////////////////////////////////////©//

#Область СлужебныйПрограммныйИнтерфейс

Процедура ИсполняемыеСценарии() Экспорт
	
	ЮТТесты.ВТранзакции()
		.ДобавитьТестовыйНабор("Преобразование значения в строку")
			.ДобавитьТест("ЗначениеВСтроку")
				.СПараметрами(Неопределено, "Неопределено")
				.СПараметрами("", """""")
				.СПараметрами(Истина, "Истина")
				.СПараметрами(Ложь, "Ложь")
				.СПараметрами("Тестовая строка", """Тестовая строка""")
				.СПараметрами("Строка с ""кавычками""", """Строка с """"кавычками""""""")
				.СПараметрами("Первая строка" + Символы.ПС + "Вторая строка", """Первая строка" + Символы.ПС + "|Вторая строка""")
				.СПараметрами(123, "123")
				.СПараметрами(0, "0")
				.СПараметрами(-12300, "-12300")
				.СПараметрами(123.45, "123.45")
				.СПараметрами(0.5, "0.5")
				.СПараметрами('20240115 12:30:45', "'2024.01.15 12:30:45'")
				.СПараметрами('20231231 23:59:59', "'2023.12.31 23:59:59'")
				.СПараметрами('20240101 00:00:00', "'2024.01.01 00:00:00'")
				.СПараметрами(Перечисления.PushУведомления.ИспользоватьВспомогательныйСервис, "Перечисления.PushУведомления.ИспользоватьВспомогательныйСервис")
				.СПараметрами(Новый ОписаниеТипов("Булево"), "Новый ОписаниеТипов(""Булево"")")
				.СПараметрами(Новый ОписаниеТипов("Массив"), "Новый ОписаниеТипов(""Массив"")")
			.ДобавитьТест("ЗначениеВСтроку_ОписаниеТиповСКвалификаторами")
			.ДобавитьТест("ЗначениеВСтроку_ОписаниеТиповСоставное")
				.СПараметрами(Новый ОписаниеТипов("Число, Строка"))
			.ДобавитьТест("ЗначениеВСтроку_НеподдерживаемыйТип")
				.СПараметрами(Новый УникальныйИдентификатор())
				.СПараметрами(Новый Структура())
			.ДобавитьСерверныйТест("ЗначениеВСтроку_СправочникПредопределенный")
			.ДобавитьСерверныйТест("ЗначениеВСтроку_СправочникПоКоду")
			.ДобавитьСерверныйТест("ЗначениеВСтроку_Документ")
			.ДобавитьСерверныйТест("ЗначениеВСтроку_ПланСчетов")
		.ДобавитьТестовыйНабор("Генерация кода конструктора.")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_ПустойМассив")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_ОдинСправочник")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_ОдинДокумент")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_НесколькоОбъектов")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_ДокументСТабличнойЧастью")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_СправочникСРеквизитами")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_ДокументПроведенный")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_ДокументСПометкойУдаления")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_СправочникСПометкойУдаления")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_ОбъектыСЗависимостями")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_ДублирующиесяСсылки")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_ПовторяющиесяСсылкиВРеквизитах")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_ФорматИменованияПоТипу")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_ФорматИменованияПоПредставлению")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_ФорматИменованияПоТипуИПредставлению")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_НеконфликтующиеИменаПеременных")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_ПропускатьПустыеЗначения")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_НеПропускатьПустыеЗначения")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_ИспользоватьПоиск")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_НеИспользоватьПоиск")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_НеопределенныеНастройки")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_ГруппаСправочника")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_ДокументСТабличнойЧастьюССсылками")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_МножественныеСсылкиВОбъекте")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_СправочникСоСсылкойНаСправочник")
			.ДобавитьСерверныйТест("СформироватьКодПоСсылкамНаОбъекты_ПорядокГенерацииПоЗависимостям")
	;
	
КонецПроцедуры

Процедура ЗначениеВСтроку(Значение, ОжидаемыйРезультат) Экспорт
	
	Результат = ЮТГенераторКодаСлужебныйСервер.ЗначениеВСтроку(Значение);
	
	ЮТест.ОжидаетЧто(Результат)
		.Равно(ОжидаемыйРезультат);
	
КонецПроцедуры

Процедура ЗначениеВСтроку_ОписаниеТиповСКвалификаторами() Экспорт
	
	// Тест для строки с фиксированной длиной
	ОписаниеТиповСтрока = Новый ОписаниеТипов("Строка", , , Новый КвалификаторыСтроки(10));
	Результат = ЮТГенераторКодаСлужебныйСервер.ЗначениеВСтроку(ОписаниеТиповСтрока);
	ЮТест.ОжидаетЧто(Результат)
		.Равно("Новый ОписаниеТипов(""Строка(10)"")");
	
	// Тест для строки переменной длины
	ОписаниеТиповСтрокаПеременная = Новый ОписаниеТипов("Строка", , , Новый КвалификаторыСтроки(0, ДопустимаяДлина.Переменная));
	Результат = ЮТГенераторКодаСлужебныйСервер.ЗначениеВСтроку(ОписаниеТиповСтрокаПеременная);
	ЮТест.ОжидаетЧто(Результат)
		.Равно("Новый ОписаниеТипов(""Строка(0)"")");
	
	// Тест для числа с квалификаторами
	ОписаниеТиповЧисло = Новый ОписаниеТипов("Число", , Новый КвалификаторыЧисла(10, 2));
	Результат = ЮТГенераторКодаСлужебныйСервер.ЗначениеВСтроку(ОписаниеТиповЧисло);
	ЮТест.ОжидаетЧто(Результат)
		.Равно("Новый ОписаниеТипов(""Число(10, 2)"")");
	
	// Тест для даты (по умолчанию имеет квалификатор "Дата и время")
	ОписаниеТиповДата = Новый ОписаниеТипов("Дата");
	Результат = ЮТГенераторКодаСлужебныйСервер.ЗначениеВСтроку(ОписаниеТиповДата);
	ЮТест.ОжидаетЧто(Результат)
		.Равно("Новый ОписаниеТипов(""Дата(Дата и время)"")");
	
КонецПроцедуры

Процедура ЗначениеВСтроку_ОписаниеТиповСоставное(Значение) Экспорт
	
	Результат = ЮТГенераторКодаСлужебныйСервер.ЗначениеВСтроку(Значение);
	
	// Проверяем, что результат содержит оба типа (порядок может быть любым)
	ЮТест.ОжидаетЧто(Результат)
		.НачинаетсяС("Новый ОписаниеТипов(""")
		.ЗаканчиваетсяНа(""")");
	
	// Проверяем наличие обоих типов
	ЮТест.ОжидаетЧто(Результат)
		.Содержит("Число");
	
	ЮТест.ОжидаетЧто(Результат)
		.Содержит("Строка");
	
КонецПроцедуры

Процедура ЗначениеВСтроку_НеподдерживаемыйТип(Значение) Экспорт
	
	Результат = ЮТГенераторКодаСлужебныйСервер.ЗначениеВСтроку(Значение);
	
	ТипЗначения = ТипЗнч(Значение);
	Сообщение = СтрШаблон("ЗначениеВСтроку(%1)", ТипЗначения);
	
	// Неподдерживаемый тип должен возвращать сообщение об ошибке
	ЮТест.ОжидаетЧто(Результат, Сообщение)
		.НачинаетсяС("!Тип (")
		.ЗаканчиваетсяНа(") не поддерживается!");
	
КонецПроцедуры

#Если Сервер Тогда

Процедура ЗначениеВСтроку_СправочникПредопределенный() Экспорт
	
	ПредопределенноеЗначение = Справочники.ВидыЦен.Закупочная;
	
	Результат = ЮТГенераторКодаСлужебныйСервер.ЗначениеВСтроку(ПредопределенноеЗначение);
	
	ЮТест.ОжидаетЧто(Результат)
		.Содержит("Справочники.ВидыЦен.Закупочная");
	
КонецПроцедуры

Процедура ЗначениеВСтроку_СправочникПоКоду() Экспорт
	
	КодСправочника = ЮТест.Данные().СлучайнаяСтрока(9);
	Справочник = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.Установить("Код", КодСправочника)
		.Записать();
	
	Результат = ЮТГенераторКодаСлужебныйСервер.ЗначениеВСтроку(Справочник);
	
	ЮТест.ОжидаетЧто(Результат)
		.НачинаетсяС("Справочники.Товары.НайтиПоКоду(""")
		.Содержит(КодСправочника);
	
КонецПроцедуры

Процедура ЗначениеВСтроку_Документ() Экспорт
	
	НомерДокумента = "001";
	ДатаДокумента = '20240115 10:00:00';
	Документ = ЮТест.Данные().КонструкторОбъекта("Документ.УстановкаЦен")
		.Установить("Номер", НомерДокумента)
		.Установить("Дата", ДатаДокумента)
		.Записать();
	
	Результат = ЮТГенераторКодаСлужебныйСервер.ЗначениеВСтроку(Документ);
	
	ЮТест.ОжидаетЧто(Результат)
		.НачинаетсяС("Документы.УстановкаЦен.НайтиПоНомеру(""")
		.Содержит(НомерДокумента)
		.Содержит("'2024.01.15 10:00:00'");
	
КонецПроцедуры

Процедура ЗначениеВСтроку_ПланСчетов() Экспорт
	
	// План счетов Основной имеет код
	КодСчета = "01";
	Счет = ПланыСчетов.Основной.НайтиПоКоду(КодСчета);
	
	Если Не ЗначениеЗаполнено(Счет) Тогда
		ЮТест.Пропустить("В базе нет счета с кодом " + КодСчета);
	КонецЕсли;
	
	Результат = ЮТГенераторКодаСлужебныйСервер.ЗначениеВСтроку(Счет);
	
	ЮТест.ОжидаетЧто(Результат)
		.НачинаетсяС("ПланыСчетов.Основной.НайтиПоКоду(""")
		.Содержит(КодСчета)
		.Содержит(""")")
		.Содержит(" // ", "Проверяем наличие комментария с наименованием");
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_ПустойМассив() Экспорт
	
	СсылкиНаОбъекты = Новый Массив;
	НастройкиФормирования = Новый Структура;
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, НастройкиФормирования);
	
	ЮТест.ОжидаетЧто(Результат)
		.ИмеетТип("Строка")
		.НеЗаполнено();
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_ОдинСправочник() Экспорт
	
	НаименованиеСправочника = "ТестовыйТовар" + Строка(ТекущаяДатаСеанса());
	Справочник = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.Установить("Наименование", НаименованиеСправочника)
		.Записать();
	
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Справочник);
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, Новый Структура);
	
	ЮТест.ОжидаетЧто(Результат)
		.Содержит("Товары = ЮТест.Данные().КонструкторОбъекта(""Справочник.Товары"")")
		.Содержит(".Установить(""Наименование"",")
		.Содержит(НаименованиеСправочника)
		.Содержит(".Записать()");
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_ОдинДокумент() Экспорт
	
	НомерДокумента = "001";
	ДатаДокумента = '20240115 10:00:00';
	Документ = ЮТест.Данные().КонструкторОбъекта("Документ.УстановкаЦен")
		.Установить("Номер", НомерДокумента)
		.Установить("Дата", ДатаДокумента)
		.Записать();
	
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Документ);
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, Новый Структура);
	
	ЮТест.ОжидаетЧто(Результат)
		.Содержит("УстановкаЦен = ЮТест.Данные().КонструкторОбъекта(""Документ.УстановкаЦен"")")
		.Содержит(".Установить(""Дата"",")
		.Содержит(".Записать()");
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_НесколькоОбъектов() Экспорт
	
	НаименованиеСправочника = "ТестовыйТовар" + Строка(ТекущаяДатаСеанса());
	Справочник = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.Установить("Наименование", НаименованиеСправочника)
		.Записать();
	
	НомерДокумента = "002";
	ДатаДокумента = '20240115 10:00:00';
	Документ = ЮТест.Данные().КонструкторОбъекта("Документ.УстановкаЦен")
		.Установить("Номер", НомерДокумента)
		.Установить("Дата", ДатаДокумента)
		.Записать();
	
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Справочник, Документ);
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, Новый Структура);
	
	ЮТест.ОжидаетЧто(Результат)
		.Содержит("Товары = ЮТест.Данные().КонструкторОбъекта(""Справочник.Товары"")")
		.Содержит("УстановкаЦен = ЮТест.Данные().КонструкторОбъекта(""Документ.УстановкаЦен"")");
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_ДокументСТабличнойЧастью() Экспорт
	
	Документ = ЮТест.Данные().КонструкторОбъекта("Документ.УстановкаЦен")
		.Установить("Номер", "003")
		.Установить("Дата", '20240115 10:00:00')
		.ТабличнаяЧасть("Цены")
			.ДобавитьСтроку()
			.Установить("Цена", 100)
			.Установить("ВидЦены", Справочники.ВидыЦен.Закупочная)
			.ФикцияРеквизитов("Товар")
		.Записать();
	
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Документ);
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, Новый Структура);
	
	ЮТест.ОжидаетЧто(Результат)
		.Содержит("УстановкаЦен = ЮТест.Данные().КонструкторОбъекта(""Документ.УстановкаЦен"")")
		.Содержит(".ТабличнаяЧасть(""Цены"")")
		.Содержит(".ДобавитьСтроку()")
		.Содержит(".Установить(""Цена"",")
		.Содержит(".Записать()");
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_СправочникСРеквизитами() Экспорт
	
	НаименованиеСправочника = "ТестовыйТовар" + Строка(ТекущаяДатаСеанса());
	Артикул = Формат(ТекущаяДатаСеанса(), "ДФ=ddMMyyyy-HHmmss;");
	Справочник = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.Установить("Наименование", НаименованиеСправочника)
		.Установить("Артикул", Артикул)
		.Записать();
	
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Справочник);
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, Новый Структура);
	
	ЮТест.ОжидаетЧто(Результат)
		.Содержит("Товары = ЮТест.Данные().КонструкторОбъекта(""Справочник.Товары"")")
		.Содержит(".Установить(""Наименование"",")
		.Содержит(НаименованиеСправочника)
		.Содержит(".Установить(""Артикул"",")
		.Содержит(Артикул)
		.Содержит(".Записать()");
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_ДокументПроведенный() Экспорт
	
	ДокументСсылка = ЮТест.Данные().КонструкторОбъекта("Документ.УстановкаЦен")
		.Установить("Номер", "004")
		.Установить("Дата", '20240115 10:00:00')
		.Провести();
	
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(ДокументСсылка);
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, Новый Структура);
	
	ЮТест.ОжидаетЧто(Результат)
		.Содержит("УстановкаЦен = ЮТест.Данные().КонструкторОбъекта(""Документ.УстановкаЦен"")")
		.Содержит(".Провести()");
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_ДокументСПометкойУдаления() Экспорт
	
	ДокументСсылка = ЮТест.Данные().КонструкторОбъекта("Документ.УстановкаЦен")
		.Установить("Номер", "005")
		.Установить("Дата", '20240115 10:00:00')
		.Установить("ПометкаУдаления", Истина)
		.Записать();
	
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(ДокументСсылка);
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, Новый Структура);
	
	ЮТест.ОжидаетЧто(Результат)
		.Содержит("УстановкаЦен = ЮТест.Данные().КонструкторОбъекта(""Документ.УстановкаЦен"")")
		.Содержит(".Установить(""ПометкаУдаления"", Истина)");
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_СправочникСПометкойУдаления() Экспорт
	
	СправочникСсылка = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.Установить("Наименование", "ТестовыйТовар" + Строка(ТекущаяДатаСеанса()))
		.Установить("ПометкаУдаления", Истина)
		.Записать();
	
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(СправочникСсылка);
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, Новый Структура);
	
	ЮТест.ОжидаетЧто(Результат)
		.Содержит("Товары = ЮТест.Данные().КонструкторОбъекта(""Справочник.Товары"")")
		.Содержит(".Установить(""ПометкаУдаления"", Истина)");
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_ОбъектыСЗависимостями() Экспорт
	
	Справочник = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.Записать();
	
	Документ = ЮТест.Данные().КонструкторОбъекта("Документ.УстановкаЦен")
		.Установить("Номер", "006")
		.Установить("Дата", '20240115 10:00:00')
		.ТабличнаяЧасть("Цены")
			.ДобавитьСтроку()
			.Установить("Товар", Справочник)
			.Установить("Цена", 100)
			.Установить("ВидЦены", Справочники.ВидыЦен.Закупочная)
		.Записать();
	
	// Добавляем документ первым, чтобы проверить, что справочник все равно будет сгенерирован первым
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Документ, Справочник);
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, Новый Структура);
	
	ЮТест.ОжидаетЧто(Результат)
		.Содержит("Товары = ЮТест.Данные().КонструкторОбъекта(""Справочник.Товары"")")
		.Содержит("УстановкаЦен = ЮТест.Данные().КонструкторОбъекта(""Документ.УстановкаЦен"")");
	
	// Проверяем, что справочник генерируется раньше документа (индекс первого вхождения меньше)
	ИндексТовары = СтрНайти(Результат, "Товары = ЮТест.Данные().КонструкторОбъекта(""Справочник.Товары"")");
	ИндексУстановкаЦен = СтрНайти(Результат, "УстановкаЦен = ЮТест.Данные().КонструкторОбъекта(""Документ.УстановкаЦен"")");
	
	ЮТест.ОжидаетЧто(ИндексТовары)
		.Меньше(ИндексУстановкаЦен, "Справочник должен генерироваться раньше документа");
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_ДублирующиесяСсылки() Экспорт
	
	Справочник = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.Записать();
	
	// Добавляем одну и ту же ссылку дважды
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Справочник, Справочник);
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, Новый Структура);
	
	// Проверяем сколько раз генерируется создание объекта
	КоличествоВхождений = СтрЧислоВхождений(Результат, "ЮТест.Данные().КонструкторОбъекта(""Справочник.Товары"")");
	
	ЮТест.ОжидаетЧто(КоличествоВхождений)
		.Равно(2, "Объект должен генерироваться только один раз, даже если ссылка добавлена дважды");
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_ПовторяющиесяСсылкиВРеквизитах() Экспорт
	
	Справочник = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.Записать();
	
	Документ1 = ЮТест.Данные().КонструкторОбъекта("Документ.УстановкаЦен")
		.ТабличнаяЧасть("Цены")
			.ДобавитьСтроку()
				.Установить("Товар", Справочник)
				.Установить("Цена", 100)
				.Установить("ВидЦены", Справочники.ВидыЦен.Закупочная)
		.Записать();
	
	Документ2 = ЮТест.Данные().КонструкторОбъекта("Документ.УстановкаЦен")
		.ТабличнаяЧасть("Цены")
			.ДобавитьСтроку()
			.Установить("Товар", Справочник)
			.Установить("Цена", 200)
			.Установить("ВидЦены", Справочники.ВидыЦен.Закупочная)
		.Записать();
	
	// Добавляем только документы, но не справочник - он должен быть создан как переменная
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Документ1, Документ2);
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, Новый Структура);
	
	ЮТест.ОжидаетЧто(Результат)
		.Содержит("Товары = ")
		.Содержит(".Установить(""Товар"", Товары", "Должна использоваться переменная для повторяющейся ссылки");
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_ФорматИменованияПоТипу() Экспорт
	
	Справочник = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.Записать();
	
	Документ = ЮТест.Данные().КонструкторОбъекта("Документ.УстановкаЦен")
		.ТабличнаяЧасть("Цены")
			.ДобавитьСтроку()
			.Установить("Товар", Справочник)
			.Установить("Цена", 100)
			.Установить("ВидЦены", Справочники.ВидыЦен.Закупочная)
		.Записать();
	
	// Добавляем справочник в массив, чтобы он генерировался как переменная
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Справочник, Документ);
	
	НастройкиФормирования = ЮТГенераторКода.ПараметрыГенерацииКода();
	НастройкиФормирования.ФорматИменованияПеременных = ЮТГенераторКода.ФорматИменованияПеременных().ПоТипу;
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, НастройкиФормирования);
	
	// При формате "ПоТипу" имя переменной должно быть "Товары"
	ЮТест.ОжидаетЧто(Результат)
		.Содержит("Товары =", "Переменная должна именоваться по типу объекта");
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_ФорматИменованияПоПредставлению() Экспорт
	
	НаименованиеСправочника = "Товар" + ЮТест.Данные().СлучайнаяСтрока();
	Справочник = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.Установить("Наименование", НаименованиеСправочника)
		.Записать();
	
	Документ = ЮТест.Данные().КонструкторОбъекта("Документ.УстановкаЦен")
		.Установить("Номер", "010")
		.Установить("Дата", '20240115 10:00:00')
		.ТабличнаяЧасть("Цены")
			.ДобавитьСтроку()
			.Установить("Товар", Справочник)
			.Установить("Цена", 100)
			.Установить("ВидЦены", Справочники.ВидыЦен.Закупочная)
			.ДобавитьСтроку()
			.Установить("Товар", Справочник)
			.Установить("Цена", 100)
			.Установить("ВидЦены", Справочники.ВидыЦен.Закупочная)
		.Записать();
	
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Документ);
	
	НастройкиФормирования = ЮТГенераторКода.ПараметрыГенерацииКода();
	НастройкиФормирования.ФорматИменованияПеременных = ЮТГенераторКода.ФорматИменованияПеременных().ПоПредставлению;
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, НастройкиФормирования);
	
	// При формате "ПоПредставлению" имя переменной должно быть нормализованным представлением
	ЮТест.ОжидаетЧто(Результат)
		.Содержит(НаименованиеСправочника + " =")
		.Содержит("Установка_цен_010")
	;
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_ФорматИменованияПоТипуИПредставлению() Экспорт
	
	НаименованиеСправочника = "ТестовыйТовар" + Строка(ТекущаяДатаСеанса());
	Справочник = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.Установить("Наименование", НаименованиеСправочника)
		.Записать();
	
	Документ = ЮТест.Данные().КонструкторОбъекта("Документ.УстановкаЦен")
		.Установить("Номер", "011")
		.Установить("Дата", '20240115 10:00:00')
		.ТабличнаяЧасть("Цены")
			.ДобавитьСтроку()
			.Установить("Товар", Справочник)
			.Установить("Цена", 100)
			.Установить("ВидЦены", Справочники.ВидыЦен.Закупочная)
		.Записать();
	
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Документ);
	
	НастройкиФормирования = ЮТГенераторКода.ПараметрыГенерацииКода();
	НастройкиФормирования.ФорматИменованияПеременных = ЮТГенераторКода.ФорматИменованияПеременных().ПоТипуИПредставлению;
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, НастройкиФормирования);
	
	// При формате "ПоТипуИПредставлению" имя переменной должно быть комбинацией типа и представления
	ЮТест.ОжидаетЧто(Результат)
		.ИмеетТип("Строка")
		.Заполнено();
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_НеконфликтующиеИменаПеременных() Экспорт
	
	// Создаем несколько справочников с одинаковыми именами для проверки конфликтов
	Справочник1 = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.ФикцияОбязательныхПолей()
		.Записать();
	
	Справочник2 = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.ФикцияОбязательныхПолей()
		.Записать();
	
	Документ = ЮТест.Данные().КонструкторОбъекта("Документ.УстановкаЦен")
		.Установить("Номер", "012")
		.Установить("Дата", '20240115 10:00:00')
		.ТабличнаяЧасть("Цены")
			.ДобавитьСтроку()
			.Установить("Товар", Справочник1)
			.Установить("Цена", 100)
			.Установить("ВидЦены", Справочники.ВидыЦен.Закупочная)
			.ДобавитьСтроку()
			.Установить("Товар", Справочник1)
			.Установить("Цена", 100)
			.Установить("ВидЦены", Справочники.ВидыЦен.Закупочная)
			.ДобавитьСтроку()
			.Установить("Товар", Справочник2)
			.Установить("Цена", 200)
			.Установить("ВидЦены", Справочники.ВидыЦен.Закупочная)
			.ДобавитьСтроку()
			.Установить("Товар", Справочник2)
			.Установить("Цена", 200)
			.Установить("ВидЦены", Справочники.ВидыЦен.Закупочная)
		.Записать();
	
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Документ);
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, Новый Структура);
	
	// Проверяем, что код генерируется без ошибок
	ЮТест.ОжидаетЧто(Результат)
		.Содержит("Товары = ")
		.Содержит("Товары2 = ")
		;
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_ПропускатьПустыеЗначения() Экспорт
	
	НаименованиеСправочника = "ТестовыйТовар" + Строка(ТекущаяДатаСеанса());
	Справочник = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.Установить("Наименование", НаименованиеСправочника)
		.Записать();
	
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Справочник);
	
	НастройкиФормирования = ЮТГенераторКода.ПараметрыГенерацииКода();
	НастройкиФормирования.ПропускатьПустыеЗначения = Истина;
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, НастройкиФормирования);
	
	ЮТест.ОжидаетЧто(Результат)
		.ИмеетТип("Строка")
		.Заполнено()
		.Содержит("Товары = ЮТест.Данные().КонструкторОбъекта(""Справочник.Товары"")");
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_НеПропускатьПустыеЗначения() Экспорт
	
	НаименованиеСправочника = "ТестовыйТовар" + Строка(ТекущаяДатаСеанса());
	Справочник = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.Установить("Наименование", НаименованиеСправочника)
		.Записать();
	
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Справочник);
	
	НастройкиФормирования = ЮТГенераторКода.ПараметрыГенерацииКода();
	НастройкиФормирования.ПропускатьПустыеЗначения = Ложь;
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, НастройкиФормирования);
	
	ЮТест.ОжидаетЧто(Результат)
		.ИмеетТип("Строка")
		.Заполнено()
		.Содержит("Товары = ЮТест.Данные().КонструкторОбъекта(""Справочник.Товары"")");
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_ИспользоватьПоиск() Экспорт
	
	КодСправочника = "ТЕСТ" + Формат(ТекущаяДатаСеанса(), "ДФ=ddMMyyyyHHmmss;");
	Справочник = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.Установить("Код", КодСправочника)
		.Установить("Наименование", "ТестовыйТовар" + Строка(ТекущаяДатаСеанса()))
		.Записать();
	
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Справочник);
	
	НастройкиФормирования = ЮТГенераторКода.ПараметрыГенерацииКода();
	НастройкиФормирования.ИспользоватьПоиск = Истина;
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, НастройкиФормирования);
	
	ЮТест.ОжидаетЧто(Результат)
		.ИмеетТип("Строка")
		.Заполнено()
		.Содержит("Товары = ЮТест.Данные().КонструкторОбъекта(""Справочник.Товары"")");
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_НеИспользоватьПоиск() Экспорт
	
	КодСправочника = "ТЕСТ" + Формат(ТекущаяДатаСеанса(), "ДФ=ddMMyyyyHHmmss;");
	Справочник = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.Установить("Код", КодСправочника)
		.Установить("Наименование", "ТестовыйТовар" + Строка(ТекущаяДатаСеанса()))
		.Записать();
	
	Документ = ЮТест.Данные().КонструкторОбъекта("Документ.УстановкаЦен")
		.Установить("Номер", "013")
		.Установить("Дата", '20240115 10:00:00')
		.ТабличнаяЧасть("Цены")
			.ДобавитьСтроку()
			.Установить("Товар", Справочник)
			.Установить("Цена", 100)
			.Установить("ВидЦены", Справочники.ВидыЦен.Закупочная)
		.Записать();
	
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Документ);
	
	НастройкиФормирования = ЮТГенераторКода.ПараметрыГенерацииКода();
	НастройкиФормирования.ИспользоватьПоиск = Ложь;
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, НастройкиФормирования);
	
	// При отключенном поиске должны использоваться фикции для ссылочных реквизитов
	ЮТест.ОжидаетЧто(Результат)
		.ИмеетТип("Строка")
		.Заполнено()
		.Содержит(".Фикция(""Товар"")", "При отключенном поиске должна использоваться фикция для ссылочных реквизитов");
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_НеопределенныеНастройки() Экспорт
	
	НаименованиеСправочника = "ТестовыйТовар" + Строка(ТекущаяДатаСеанса());
	Справочник = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.Установить("Наименование", НаименованиеСправочника)
		.Записать();
	
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Справочник);
	
	// Передаем пустую структуру (что эквивалентно неопределенным настройкам)
	НастройкиФормирования = Новый Структура;
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, НастройкиФормирования);
	
	// Должны использоваться настройки по умолчанию
	ЮТест.ОжидаетЧто(Результат)
		.ИмеетТип("Строка")
		.Заполнено()
		.Содержит("Товары = ЮТест.Данные().КонструкторОбъекта(""Справочник.Товары"")");
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_ГруппаСправочника() Экспорт
	
	НаименованиеГруппы = "ТестоваяГруппа" + Строка(ТекущаяДатаСеанса());
	Группа = ЮТест.Данные().СоздатьГруппу("Справочники.Товары", НаименованиеГруппы);
	
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Группа);
	
	НастройкиФормирования = Новый Структура;
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, НастройкиФормирования);
	
	// Генератор кода использует КонструкторОбъекта для групп, который внутри использует СоздатьГруппу
	// Проверяем, что код генерируется корректно
	ЮТест.ОжидаетЧто(Результат)
		.ИмеетТип("Строка")
		.Заполнено()
		.Содержит("Товары = ЮТест.Данные().КонструкторОбъекта(""Справочник.Товары"")");
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_ДокументСТабличнойЧастьюССсылками() Экспорт
	
	НаименованиеСправочника = "ТестовыйТовар" + Строка(ТекущаяДатаСеанса());
	Справочник = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.Установить("Наименование", НаименованиеСправочника)
		.Записать();
	
	Документ = ЮТест.Данные().КонструкторОбъекта("Документ.УстановкаЦен")
		.Установить("Номер", "014")
		.Установить("Дата", '20240115 10:00:00')
		.ТабличнаяЧасть("Цены")
			.ДобавитьСтроку()
			.Установить("Товар", Справочник)
			.Установить("Цена", 100)
			.Установить("ВидЦены", Справочники.ВидыЦен.Закупочная)
		.Записать();
	
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Документ);
	
	НастройкиФормирования = Новый Структура;
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, НастройкиФормирования);
	
	ЮТест.ОжидаетЧто(Результат)
		.ИмеетТип("Строка")
		.Заполнено()
		.Содержит("УстановкаЦен = ЮТест.Данные().КонструкторОбъекта(""Документ.УстановкаЦен"")")
		.Содержит(".ТабличнаяЧасть(""Цены"")")
		.Содержит(".Установить(""Товар"",");
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_МножественныеСсылкиВОбъекте() Экспорт
	
	// Используем документ, который имеет несколько ссылочных реквизитов
	НаименованиеСправочника = "ТестовыйТовар" + Строка(ТекущаяДатаСеанса());
	Справочник = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.Установить("Наименование", НаименованиеСправочника)
		.Записать();
	
	Документ = ЮТест.Данные().КонструкторОбъекта("Документ.УстановкаЦен")
		.Установить("Номер", "015")
		.Установить("Дата", '20240115 10:00:00')
		.ТабличнаяЧасть("Цены")
			.ДобавитьСтроку()
			.Установить("Товар", Справочник)
			.Установить("Цена", 100)
			.Установить("ВидЦены", Справочники.ВидыЦен.Закупочная)
		.Записать();
	
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Документ);
	
	НастройкиФормирования = Новый Структура;
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, НастройкиФормирования);
	
	ЮТест.ОжидаетЧто(Результат)
		.ИмеетТип("Строка")
		.Заполнено()
		.Содержит("УстановкаЦен = ЮТест.Данные().КонструкторОбъекта(""Документ.УстановкаЦен"")")
		.Содержит(".Установить(""Товар"",")
		.Содержит(".Установить(""ВидЦены"",");
	
КонецПроцедуры

Процедура СформироватьКодПоСсылкамНаОбъекты_СправочникСоСсылкойНаСправочник() Экспорт
	
	// Ищем справочник, который имеет ссылку на другой справочник
	// Для демо-конфигурации используем простой сценарий
	НаименованиеСправочника = "ТестовыйТовар" + Строка(ТекущаяДатаСеанса());
	Справочник = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.Установить("Наименование", НаименованиеСправочника)
		.Записать();
	
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Справочник);
	
	НастройкиФормирования = Новый Структура;
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, НастройкиФормирования);
	
	ЮТест.ОжидаетЧто(Результат)
		.ИмеетТип("Строка")
		.Заполнено()
		.Содержит("Товары = ЮТест.Данные().КонструкторОбъекта(""Справочник.Товары"")");
	
	КонецПроцедуры
	
	Процедура СформироватьКодПоСсылкамНаОбъекты_ПорядокГенерацииПоЗависимостям() Экспорт
	
	НаименованиеСправочника = "ТестовыйТовар" + Строка(ТекущаяДатаСеанса());
	Справочник = ЮТест.Данные().КонструкторОбъекта("Справочник.Товары")
		.Установить("Наименование", НаименованиеСправочника)
		.Записать();
	
	Документ = ЮТест.Данные().КонструкторОбъекта("Документ.УстановкаЦен")
		.Установить("Номер", "016")
		.Установить("Дата", '20240115 10:00:00')
		.ТабличнаяЧасть("Цены")
			.ДобавитьСтроку()
			.Установить("Товар", Справочник)
			.Установить("Цена", 100)
			.Установить("ВидЦены", Справочники.ВидыЦен.Закупочная)
		.Записать();
	
	// Добавляем документ первым, чтобы проверить порядок генерации
	СсылкиНаОбъекты = ЮТКоллекции.ЗначениеВМассиве(Документ, Справочник);
	
	НастройкиФормирования = Новый Структура;
	
	Результат = ЮТГенераторКодаСлужебныйСервер.СформироватьКодПоСсылкамНаОбъекты(СсылкиНаОбъекты, НастройкиФормирования);
	
	ЮТест.ОжидаетЧто(Результат)
		.ИмеетТип("Строка")
		.Заполнено();
	
	// Проверяем порядок: справочник должен быть раньше документа
	ИндексТовары = СтрНайти(Результат, "Товары = ЮТест.Данные().КонструкторОбъекта(""Справочник.Товары"")");
	ИндексУстановкаЦен = СтрНайти(Результат, "УстановкаЦен = ЮТест.Данные().КонструкторОбъекта(""Документ.УстановкаЦен"")");
	
	ЮТест.ОжидаетЧто(ИндексТовары)
		.Больше(0, "Справочник должен присутствовать в коде")
		.Меньше(ИндексУстановкаЦен, "Справочник должен генерироваться раньше документа, который на него ссылается");
	
КонецПроцедуры

#КонецЕсли

#КонецОбласти
